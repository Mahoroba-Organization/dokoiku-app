# どこ行く？ 技術仕様・方式

このドキュメントは実装と同じ内容になるよう更新する。

## 目的
- 1店舗ずつ評価し、合意形成なしで上位候補を確定する。
- 「行きたい/ぶー」の連打数から個人ランキングを作成し、全体でマージする。

## データ取得
- 候補店舗は Hotpepper API から初回のみ取得し、ルーム内で固定する。
- 取得件数は 50 件（固定）。
- 予算は下限/上限を入力し、可能なら予算コードで絞り込み、取得後に文字列解析で再フィルタする。

## 投票UI
- 1回の評価は **1店舗** を表示する。
- 1投票あたり **4秒** のタップ時間を用意する。
- 操作:
  - 「行きたい」: 連打数を正のスコアとして加算
  - 「ぶー」: 連打数 × 3 を負のスコアとして加算
- 最終スコア = 行きたい回数 − (ぶー回数 × 3)

## 集計の流れ
1) 個人ごとにタップスコア（店舗ごとの平均）を算出  
2) 個人 Top-5 を確定（同点は shopId でタイブレーク）  
3) 全体マージ（Top-5 × 参加人数の平均スコア）  
4) NG を含む店舗は全体から Ban（NGが存在する場合）

## 提示の優先順
- 未表示が残っている間は未表示を優先
- 一巡後は候補プール内でジャンル偏りを抑制しつつ提示する

## 主要ファイル
- 取得/提示: `app/api/rooms/[roomId]/next-shop/route.ts`
- 投票: `app/api/rooms/[roomId]/vote/route.ts`
- 個人/全体集計: `app/lib/explore_exploit.ts`
