# どこ行く？ 技術仕様・方式

このドキュメントは実装と同じ内容になるよう更新する。

## 目的
- 2択/3択の投票を繰り返し、合意形成なしで上位候補を確定する。
- 参加者のNG（拒否）は全体順位から除外する。

## データ取得
- 候補店舗は Hotpepper API から初回のみ取得し、ルーム内で固定する。
- 取得件数は 30 件（固定）。
- 予算は下限/上限を入力し、可能なら予算コードで絞り込み、取得後に文字列解析で再フィルタする。

## 投票UI
- 1回の評価は **3店舗** を表示する。
- 操作:
  - 「こっちがいい」: 選択店に高得点、他2店は低得点
  - 「どっちも微妙/行きたい」: 全店に同一得点
  - 「NG」: NG店は全体順位から除外

## 比較ログ
- 1回の評価（3店舗）から 3 組の比較ログを生成し保存する。
- 比較結果は Elo 計算に使用する。

## Elo 設定
- Base: 1000
- K: 48
- Top-5 / Top-10 ルール:
  - Top-5 内の未比較ペアが 0 であること
  - Top-5 と 6位の Elo 差が閾値以上であること

## 集計の流れ
1) 個人ごとに比較ログから Elo をバッチ計算  
2) 個人 Top-5 を確定  
3) 全体マージ（Top-5 × 参加人数）  
4) NG を含む店舗は全体から Ban

## 提示の優先順
- 未表示が残っている間は未表示を優先
- 一巡後は Top-5 内、または Top-5 vs 6〜10 の比較を優先
- 直近 20 件のペア履歴は重複を避ける

## 主要ファイル
- 取得/提示: `app/api/rooms/[roomId]/next-shop/route.ts`
- 投票/比較ログ: `app/api/rooms/[roomId]/vote/route.ts`
- Elo/判定: `app/lib/elo.ts`, `app/lib/explore_exploit.ts`
